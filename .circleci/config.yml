version: 2.1

workflows:
  version: 2
  circleci:
    jobs:
      - test
      - native-build
      - docker-build

jobs:
  test:
    docker:
      - image: node:20.3.1
    steps:
      - checkout
      - run: npm ci --prefix tests
      - run: make test

  native-build:
    docker:
      - image: debian:12.0
    steps:
      - checkout
      - run: apt update
      - run: |
          DEBIAN_FRONTEND=noninteractive apt-get install --yes \
            ca-certificates curl git pandoc \
            build-essential meson \
            nodejs npm \
            composer php php-cli php-common php-mbstring php-zip \
            python3 python3-dev python3-pip python3-venv \
            bundler ruby ruby-build ruby-dev \
            rust-all
      - run: make bootstrap

  docker-build:
    docker:
      - image: docker:24.0.2
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.14
          # Current circleci docker default version is 17.09.0-ce https://circleci.com/docs/2.0/building-docker-images/#docker-version
          # But during installation of php, some utilities run statx syscalls
          # To use statx calls, the docker host must run 18.04+ https://github.com/gem/oq-qgis-server/issues/1
          # See also https://github.com/rust-lang/rust/issues/65662
          # This only occurs after upgrading to debian:bullseye, might be because it includes newer php versions with newer utilities https://forums.docker.com/t/multiple-projects-stopped-building-on-docker-hub-operation-not-permitted/92570/11
          # But we can't downgrade to buster, because it has other issues, much older packages in general
          # So this workaround is needed for the time being
      - run: apk update --no-cache
      - run: apk add --no-cache make
      - run: make build
      - run: make run
